Транзакція - це послідовність операцій з базою даних, які виконуються як єдине ціле. Тобто або всі операції виконуються успішно, або жодна з них не застосовується (принцип "все або нічого").
### ACID
ACID - це абревіатура, яка описує 4 ключові властивості транзакцій:
1. **Atomicity (Атомарність)**
- Транзакція виконується повністю або не виконується взагалі
- Якщо стається помилка, всі зміни відкочуються (rollback)
- Приклад: переказ грошей між рахунками - або гроші списуються з одного рахунку і зараховуються на інший, або не відбувається жодних змін
2. **Consistency (Узгодженість)**
- База даних повинна перебувати в узгодженому стані до і після транзакції
- Всі обмеження цілісності (constraints) мають виконуватись
- Приклад: якщо є обмеження, що баланс не може бути від'ємним, транзакція не повинна це порушувати
3. **Isolation (Ізоляція)**
- Транзакції виконуються незалежно одна від одної
- Проміжні результати однієї транзакції не видимі для інших транзакцій
- Рівень ізоляції визначає, наскільки строго це правило виконується
4. **Durability (Довговічність)**
- Після завершення транзакції (commit) зміни стають постійними
- Зміни зберігаються навіть при збої системи
- Зазвичай забезпечується записом у журнал транзакцій на диск
### Рівні ізоляції транзакцій
Існує 4 стандартних рівні ізоляції, кожен з яких захищає від певних аномалій:
1. **READ UNCOMMITTED** (найнижчий рівень) - коли транзакція може бачити результати інших транзакцій, коли вони ще не закомічені.
- Дозволяє читати незафіксовані зміни інших транзакцій
- Можливі "брудні читання" (dirty reads)
- Рідко використовується на практиці
2. **READ COMMITTED** - коли транзакція бачить лише ті зміні, які є закоміченими. (По дефолту юзається в Postgres, MS SQL, Oracle)
- Можна читати тільки зафіксовані зміни
- Захищає від "брудного читання"
- Можливе "неповторюване читання" (non-repeatable reads)
- Типовий рівень за замовчуванням у багатьох СУБД
3. **REPEATABLE READ** - поки транзакція не завершиться, ніхто паралельно не може змінювати чи видаляти рядки які вона вже прочитала.
- Гарантує, що повторне читання тих самих даних дасть той самий результат
- Захищає від "неповторюваного читання"
- Можливі "фантомні читання" (phantom reads)
- Типовий рівень у MySQL/InnoDB
4. **SERIALIZABLE** (найвищий рівень) - блокує іншим транзакціям доступ до даних, з якими працює ця транзакція. Усі транзакції відбуваються послідовно.
- Повна ізоляція транзакцій
- Захищає від усіх аномалій
- Найбезпечніший, але найповільніший рівень

##### Встановлення рівня ізоляції в POSTGRES:
`SET SESSION CHARACTERISTICS AS TRANSACTION ISOLATION LEVEL REPEATABLE READ;`
##### Таблиця залежності аномалій від рівня ізоляції:

|                 | Dirty read | Non-repeatable read | Phantom read |
| :-------------: | :--------: | :-----------------: | :----------: |
|  Serializable   |     no     |         no          |      no      |
| Repeatable read |     no     |         no          |     yes      |
|  Read commited  |     no     |         yes         |     yes      |
| Read uncommited |    yes     |         yes         |     yes      |

##### Аномалії, які можуть виникати:
1. **Dirty Read (Брудне читання)** - читання незафіксованих змін іншої транзакції
- Проблема: якщо та транзакція відкотиться, ми працювали з неправильними даними
2. **Non-repeatable Read (Неповторюване читання)** - коли одна транзакція двічі читає одні й ті ж дані, але кожен раз це різний результат через те, що якась коротенька паралельна транзакція виконалась між цими двома читаннями.
- При повторному читанні в рамках однієї транзакції дані змінились
- Інша транзакція встигла зафіксувати зміни між нашими читаннями
3. **Phantom Read (Фантомне читання)**
- При повторному читанні з'являються нові рядки, які задовольняють умову
- Інша транзакція встигла додати дані

##### Специфічні рівні ізоляції
- **SNAPSHOT ISOLATION** (SQL SERVER бд) - довзоляє транзакціям бачити знміок бази даних на момент початку транзакції, усуваючи цим фантомне читання і нон ріпітабл і не блокує дані при читанні, що забезпечує паралелізм(одночасне читання одних і тих самих даних різними транзакціями) - теж за рахунок MVCC. Але снепшот ізолейшн не гарантує повну серіалізабельність, так як можливі конфлікти при записі, коли дві транзакції намагаються змінити один і той самий запис.
- **SERIALIZABLE SNAPSHOT ISOLATION** (POSTGRES бд) - працює із версіями бази і використовує технологію MVCC, через що SERIALIZABLE стає набагто більш зручним, так як SSI ефективно працює з конфліктами, а не просто жостко блокує діапазони.
- **CURSOR STABILITY** (Db 2 бд) - блокує теперішній рядок, прочитаний через деякий курсор(курсор ми спеціально ставимо у запиті, і він буде, наприклад, ходити по кожному рядку нашого запиту по порядку). З рівнем CURSOR STABILITY ми блокуємо тільки той рядок, на якому зараз знаходиться курсор.
- **READ STABILITY** (Db 2 бд) - забезпечує ситуацію, коли дані, прочитані однією транзакцією, не будуть змінені іншою транзакцією до завершення першої транзакції. Тобто тут не будуть проблеми Non-repeatable read, але можуть бути фантомні читання.

##### Додаткові аномалії
1. **Lost update** - коли дві транзакції одночаасно читають і змінюють одні і ті ж дані, і при цьому одна зі змін може втратитись.
2. **Out-of-order read** - коли кілька читань виконуються в невпорядкованій черзі, що може привести до неправильних результатів в транзакціях. 

### MVCC
MVCC (Multiversion Concurrency Control) - це метод керування конкурентним доступом до даних в БД, який дозволяє кільком транзакціям працювати одночасно без конфліктів. MVCC підтримує високу продуктивність і ізоляцію транзакцій, мінімізуючи блокування і покращуючи паралелізм.
MVCC дозволяє кожній транзакції працювати із "Власною версією БД".
##### Особливості MVCC:
1. Багатоверсійність - MVCC створює версії даних. Кожна транзакція баче дані в тому стані, в якому вони були на момент початку транзакції. Оновлення даних в цій транзакції створює нову версію оновленого рядка. (Версія містить інфу про транзакцію, яка її створила) Після цього у наступних транзакціях буде вже ця версія юзатись.
2. Ізоляція транзакцій - транзакції бачать тільки ті дані, які були зафіксовані до її початку. Це запобігає брудному читанню, нонріпітабл і фантомному читанню.
3. Відсутність блокувань на читання. Читання даних не блокує запис, а запис не блокує читання.
4. Керування конфліктами. Конфлікти між транзакціями вирішують на їх коміта. Якщо одна із транзакцій не можу бути закомічена через конфілкт, її можна буде відкотити.